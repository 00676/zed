import * as fs from "fs/promises"
import * as fsSync from "fs"
import * as path from "path"
import { compile } from "json-schema-to-typescript"

const BANNER = `/*
* This file is autogenerated
*/\n\n`
const dirname = __dirname

async function main() {
    const schemasPath = path.join(dirname, "../../", "crates/theme/schemas")
    const schemaFiles = (await fs.readdir(schemasPath)).filter((x) =>
        x.endsWith(".json")
    )

    const compiledTypes = new Set()

    for (const filename of schemaFiles) {
        const filePath = path.join(schemasPath, filename)
        const fileContents = await fs.readFile(filePath)
        const schema = JSON.parse(fileContents.toString())
        const compiled = await compile(schema, schema.title, {
            bannerComment: "",
        })
        const eachType = compiled.split("export")
        for (const type of eachType) {
            if (!type) {
                continue
            }
            compiledTypes.add("export " + type.trim())
        }
    }

    const output = BANNER + Array.from(compiledTypes).join("\n\n")
    const outputPath = path.join(dirname, "../../styles/src/types/zed.ts")

    try {
        const existing = await fs.readFile(outputPath)
        if (existing.toString() == output) {
            // Skip writing if it hasn't changed
            console.log("Schemas are up to date")
            return
        }
    } catch (e) {
        // @ts-expect-error - It's fine if there's no output from a previous run.
        if (e.code !== "ENOENT") {
            throw e
        }
    }

    const typesDic = path.dirname(outputPath)
    if (!fsSync.existsSync(typesDic)) {
        await fs.mkdir(typesDic)
    }
    await fs.writeFile(outputPath, output)
    console.log(`Wrote Typescript types to ${outputPath}`)
}

main().catch((e) => {
    console.error(e)
    process.exit(1)
})
